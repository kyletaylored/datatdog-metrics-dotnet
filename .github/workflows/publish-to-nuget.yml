name: Publish to NuGet

on:
  # Automatic trigger when a release is published
  release:
    types: [published]

env:
  NUGET_SOURCE: 'https://api.nuget.org/v3/index.json'

jobs:
  # Validate and extract tag info from release
  validate-tag:
    name: Validate Tag
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.get-tag.outputs.tag }}
      version: ${{ steps.get-tag.outputs.version }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Need full history to check tags

      - name: Validate and extract tag info
        id: get-tag
        run: |
          # Get the tag from the release event
          TAG="${{ github.event.release.tag_name }}"

          if [ -z "$TAG" ]; then
            echo "âŒ Error: No release tag found in event"
            exit 1
          fi

          echo "ðŸ“¦ Publishing release: $TAG"

          # Check if tag exists
          if ! git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "âŒ Error: Tag '$TAG' does not exist in this repository"
            exit 1
          fi

          echo "âœ“ Tag exists: $TAG"

          # Extract version (remove 'v' prefix if present)
          VERSION="${TAG#v}"
          echo "âœ“ Version: $VERSION"
          echo "ðŸ“¤ Will publish to NuGet.org and GitHub Packages"

          # Set outputs
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Display configuration
        run: |
          echo "## ðŸ“¦ NuGet Publish" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Publishing packages from release to NuGet.org" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag**: \`${{ steps.get-tag.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: \`${{ steps.get-tag.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Release**: [${{ steps.get-tag.outputs.tag }}](${{ github.event.release.html_url }})" >> $GITHUB_STEP_SUMMARY

  # Validate version format
  validate-version:
    name: Validate Version
    needs: validate-tag
    uses: ./.github/workflows/validate-version.yml
    with:
      release_tag: ${{ needs.validate-tag.outputs.tag }}

  # Download packages from GitHub Release
  download-release-packages:
    needs: [validate-tag, validate-version]
    name: Download Release Packages
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Download release assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ needs.validate-tag.outputs.tag }}"
          echo "Downloading packages from release $TAG..."

          # Download all .nupkg files from the release
          gh release download "$TAG" \
            --pattern "*.nupkg" \
            --dir ./packages

          echo "=== Downloaded Packages ==="
          ls -lh ./packages/
          echo ""
          echo "Total packages: $(ls -1 ./packages/*.nupkg | wc -l)"

      - name: Download checksums
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ needs.validate-tag.outputs.tag }}"
          gh release download "$TAG" \
            --pattern "checksums.txt" \
            --dir ./packages || echo "No checksums file available"

      - name: Verify checksums
        run: |
          cd ./packages
          if [ -f checksums.txt ]; then
            echo "Verifying package checksums..."
            sha256sum -c checksums.txt
            echo "All checksums verified"
          else
            echo "Warning: No checksums.txt found, skipping verification"
          fi

      - name: Upload packages for publishing
        uses: actions/upload-artifact@v6
        with:
          name: release-packages-to-publish
          path: ./packages/*.nupkg
          retention-days: 7

  # Validate packages before publishing
  validate-packages:
    name: Validate Packages
    runs-on: ubuntu-latest
    needs: download-release-packages

    steps:
      - name: Download packages
        uses: actions/download-artifact@v7
        with:
          name: release-packages-to-publish
          path: ./packages

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '10.0.x'

      - name: List packages
        run: |
          echo "=== Packages to Publish ==="
          ls -lh ./packages/
          echo ""
          echo "Total: $(ls -1 ./packages/*.nupkg | wc -l) packages"

      - name: Validate package structure
        run: |
          echo "Validating package structure..."

          for package in ./packages/*.nupkg; do
            pkg_name=$(basename "$package")
            echo ""
            echo "Validating: $pkg_name"

            # Use dotnet to validate the package
            if dotnet nuget verify "$package" 2>/dev/null; then
              echo "âœ“ Valid package structure"
            else
              echo "âš ï¸  Could not verify (may not be signed)"
            fi
          done

      - name: Test package metadata
        run: |
          echo "Checking package metadata..."

          for package in ./packages/*.nupkg; do
            pkg_name=$(basename "$package")

            # Extract package
            mkdir -p temp-pkg
            unzip -q "$package" -d temp-pkg

            # Check for nuspec
            if ls temp-pkg/*.nuspec 1> /dev/null 2>&1; then
              echo "âœ“ $pkg_name - Has .nuspec"
            else
              echo "âœ— $pkg_name - Missing .nuspec"
              rm -rf temp-pkg
              exit 1
            fi

            # Check for README
            if [ -f temp-pkg/README.md ]; then
              echo "âœ“ $pkg_name - Has README"
            else
              echo "âš ï¸  $pkg_name - Missing README"
            fi

            rm -rf temp-pkg
          done

          echo ""
          echo "âœ“ Validation complete"

  # Publish to NuGet.org
  publish-to-nuget:
    name: Publish to NuGet.org
    runs-on: ubuntu-latest
    needs: [validate-tag, validate-packages]
    environment:
      name: nuget-production
      url: https://www.nuget.org/

    steps:
      - name: Download packages
        uses: actions/download-artifact@v7
        with:
          name: release-packages-to-publish
          path: ./packages

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '10.0.x'

      - name: Publish packages to NuGet.org
        env:
          NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
        run: |
          echo "Publishing packages to NuGet.org..."
          echo ""

          SUCCESS=0
          FAILED=0
          SKIPPED=0

          for package in ./packages/*.nupkg; do
            pkg_name=$(basename "$package")
            echo "----------------------------------------"
            echo "Publishing: $pkg_name"

            if dotnet nuget push "$package" \
              --api-key "$NUGET_API_KEY" \
              --source "${{ env.NUGET_SOURCE }}" \
              --skip-duplicate \
              --timeout 300; then
              echo "âœ“ Published: $pkg_name"
              SUCCESS=$((SUCCESS + 1))
            else
              EXIT_CODE=$?
              if [ $EXIT_CODE -eq 0 ]; then
                echo "âŠ˜ Skipped (already exists): $pkg_name"
                SKIPPED=$((SKIPPED + 1))
              else
                echo "âœ— Failed: $pkg_name (exit code: $EXIT_CODE)"
                FAILED=$((FAILED + 1))
              fi
            fi
            echo ""
          done

          echo "========================================"
          echo "         PUBLISH SUMMARY"
          echo "========================================"
          echo "Successfully Published: $SUCCESS"
          echo "Skipped (duplicates):   $SKIPPED"
          echo "Failed:                 $FAILED"
          echo "========================================"
          echo ""

          if [ $FAILED -gt 0 ]; then
            echo "Some packages failed to publish!"
            exit 1
          fi

          if [ $SUCCESS -eq 0 ] && [ $SKIPPED -eq 0 ]; then
            echo "No packages were published or skipped!"
            exit 1
          fi

          echo "âœ“ Publish operation completed successfully!"

      - name: Create publish summary
        run: |
          echo "# NuGet Publish Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Published from Release" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Release Tag**: ${{ needs.validate-tag.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Packages**: $(ls -1 ./packages/*.nupkg | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Links" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [NuGet Package](https://www.nuget.org/packages/kyletaylored.Datadog.Metrics/)" >> $GITHUB_STEP_SUMMARY
          echo "- [NuGet Profile](https://www.nuget.org/profiles/kyletaylored)" >> $GITHUB_STEP_SUMMARY
          echo "- [GitHub Release](${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ needs.validate-tag.outputs.tag }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Availability" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Packages will be available on NuGet.org within 15-30 minutes." >> $GITHUB_STEP_SUMMARY

  # Publish to GitHub Package Registry
  publish-to-github:
    name: Publish to GitHub Packages
    runs-on: ubuntu-latest
    needs: [validate-tag, validate-packages]
    permissions:
      packages: write
      contents: read

    steps:
      - name: Download packages
        uses: actions/download-artifact@v7
        with:
          name: release-packages-to-publish
          path: ./packages

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '10.0.x'

      - name: Publish packages to GitHub Packages
        run: |
          echo "Publishing packages to GitHub Package Registry..."
          echo ""

          SUCCESS=0
          FAILED=0
          SKIPPED=0

          for package in ./packages/*.nupkg; do
            pkg_name=$(basename "$package")
            echo "----------------------------------------"
            echo "Publishing: $pkg_name"

            if dotnet nuget push "$package" \
              --api-key ${{ secrets.GITHUB_TOKEN }} \
              --source https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json \
              --skip-duplicate \
              --timeout 300; then
              echo "âœ“ Published: $pkg_name"
              SUCCESS=$((SUCCESS + 1))
            else
              EXIT_CODE=$?
              if [ $EXIT_CODE -eq 0 ]; then
                echo "âŠ˜ Skipped (already exists): $pkg_name"
                SKIPPED=$((SKIPPED + 1))
              else
                echo "âš ï¸  Failed: $pkg_name (exit code: $EXIT_CODE)"
                FAILED=$((FAILED + 1))
              fi
            fi
            echo ""
          done

          echo "========================================"
          echo "         PUBLISH SUMMARY"
          echo "========================================"
          echo "Successfully Published: $SUCCESS"
          echo "Skipped (duplicates):   $SKIPPED"
          echo "Failed:                 $FAILED"
          echo "========================================"
          echo ""

          if [ $FAILED -gt 0 ]; then
            echo "Warning: Some packages failed to publish to GitHub Packages"
            echo "This is non-fatal - packages may still be available on NuGet.org"
          else
            echo "âœ“ GitHub Packages publish operation completed successfully!"
          fi

      - name: Create GitHub Packages publish summary
        run: |
          echo "# GitHub Packages Publish Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Published from Release" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Release Tag**: ${{ needs.validate-tag.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Packages**: $(ls -1 ./packages/*.nupkg | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Links" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [GitHub Package](https://github.com/${{ github.repository }}/pkgs/nuget/kyletaylored.Datadog.Metrics)" >> $GITHUB_STEP_SUMMARY
          echo "- [All Packages](https://github.com/${{ github.repository_owner }}?tab=packages)" >> $GITHUB_STEP_SUMMARY
          echo "- [GitHub Release](${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ needs.validate-tag.outputs.tag }})" >> $GITHUB_STEP_SUMMARY
